'use strict'
/******************************************************************************
  STACK
******************************************************************************/
const diff    = require('virtual-dom/diff')
const patch   = require('virtual-dom/patch')
const create  = require('virtual-dom/create-element')
const stream  = require('readable-stream')
// const vselect = require('vtree-select')
/******************************************************************************
  CUSTOM
******************************************************************************/
const type   = require('component-type')
var isDOM    = function (x) { return type(x) === 'element' }

/******************************************************************************
  MAIN

  API: css selector OR dom node
******************************************************************************/
module.exports = function vcs2dom (opts) {

  var target = opts.target
  // @TODO: where to set boilerplate in general?
  document.title = target  // @TODO: set in other ways - from package.json?

  var globalStyles = opts.globalStyles ?
    opts.globalStyles
    : 'body { margin: 0; }'

  var styleElement = document.createElement('style')
  styleElement.setAttribute('text', 'text/css')
  styleElement.innerHTML = globalStyles
  document.head.appendChild(styleElement)

  // <!DOCTYPE html>
  // <html lang="en">
  // <head>
  //   <meta charset="UTF-8">
  //   <meta name="viewport" content="width=device-width, initial-scale=1.0">
  //   <title>Sidecar Basic Example</title>
  //
  //   <link href="../common.css" rel="stylesheet">
  // </head>




  target = validateTarget(target) // might throw
  var element, patches, oldTree
  function write (vtree, encoding, next) {
    try {
      validateChunk(vtree) // might throw
      if (oldTree) {
        patches = diff(oldTree, vtree)
        element = patch(element, patches)
      } else {
        element = create(vtree, {})
        target.appendChild(element)
      }
      oldTree = vtree
      next()
    } catch (error) { next(error) }
  }
  return new stream.Writable({ write: write, objectMode: true })
}
function validateTarget (target) {
  if (typeof target ==='string') { target = document.querySelector(target) }
  if (!isDOM(target)) {
    var msg = target + ' is not a valid `DOM node selector`'
    throw new Error(msg)
  }
  return target
}
function validateChunk (vtree) { // @TODO: validate vtree
  if (typeof vtree === 'object') { return true }
  else {
    throw new Error('invalid vtree was piped to the engine: ' + vtree)
  }
}
